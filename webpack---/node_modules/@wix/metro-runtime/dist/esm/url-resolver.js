import {
    findByPath
} from './utils';
var USER_DOMAIN = '_';
var DOMAINS = ['wix.com', 'editorx.com'];
var WIX_API_DOMAINS = ['42.wixprod.net'];
var REGEX_CAPTURE_PROTO_FIELD = /{(.*)}/;
var REGEX_CAPTURE_DOMAINS = new RegExp("\\.(".concat(DOMAINS.join('|'), ")$"));
var REGEX_CAPTURE_API_DOMAINS = new RegExp("\\.(".concat(WIX_API_DOMAINS.join('|'), ")$"));
export function resolveUrl(opts) {
    var domain = resolveDomain(opts.host);
    var mappings = resolveMappingsByDomain(domain, opts.domainToMappings);
    var path = injectDataIntoProtoPath(opts.protoPath, opts.data || {});
    return resolvePath(path, mappings);
}

function injectDataIntoProtoPath(protoPath, data) {
    return protoPath
        .split('/')
        .map(function(path) {
            return maybeProtoPathToData(path, data);
        })
        .join('/');
}

function maybeProtoPathToData(protoPath, data) {
    var field = (protoPath.match(REGEX_CAPTURE_PROTO_FIELD) || [])[1];
    if (field) {
        return findByPath(data, field);
    }
    return protoPath;
}

function resolveDomain(host) {
    var resolvedHost = fixHostExceptions(host);
    return resolvedHost
        .replace(REGEX_CAPTURE_DOMAINS, '._base_domain_')
        .replace(REGEX_CAPTURE_API_DOMAINS, '._api_base_domain_');
}
// hosts which standard string replacing doesn't apply to them, will be fixed here.
function fixHostExceptions(host) {
    // https://system-kb.wixanswers.com/kb/en/article/editorx-domains-matching-to-wixcom
    return host.replace('create.editorx.com', 'editor.editorx.com');
}

function resolveMappingsByDomain(domain, domainToMappings) {
    var mappings = domainToMappings[domain] || domainToMappings[USER_DOMAIN];
    if (!mappings) {
        if (isBaseDomain(domain)) {
            // fallback <lang>.wix.com sub domains to www.wix.com
            // since all of the languages subdomain are not mapped automatically in FP and we want to support those kind of calls
            // for example: fr.wix.com
            return domainToMappings[wwwBaseDomain];
        }
    }
    return mappings;
}

function resolvePath(protoPath, mappings) {
    var mapping = mappings === null || mappings === void 0 ? void 0 : mappings.find(function(m) {
        return protoPath.startsWith(m.destPath);
    });
    if (!mapping) {
        // todo: should we return the path? if no - what should we do in case of testings?
        return protoPath;
    }
    return mapping.srcPath + protoPath.slice(mapping.destPath.length);
}

function isBaseDomain(domain) {
    return !!domain.match(/\._base_domain_$/);
}
var wwwBaseDomain = 'www._base_domain_';
//# sourceMappingURL=url-resolver.js.map